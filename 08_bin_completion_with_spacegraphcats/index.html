
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://dib-lab.github.io/dib_rotation/08_bin_completion_with_spacegraphcats/">
      
      
        <link rel="prev" href="../07_taxonomic_discovery_with_sourmash/">
      
      
        <link rel="next" href="../09_assembling_a_nbhd/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.8">
    
    
      
        <title>Bin Completion with Spacegraphcats - dib-lab metagenomics rotation project</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f2e4d321.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="black">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#analysis-options-for-metagenome-samples" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="dib-lab metagenomics rotation project" class="md-header__button md-logo" aria-label="dib-lab metagenomics rotation project" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            dib-lab metagenomics rotation project
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Bin Completion with Spacegraphcats
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/dib-lab/dib_rotation" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    dib_rotation
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="dib-lab metagenomics rotation project" class="md-nav__button md-logo" aria-label="dib-lab metagenomics rotation project" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82Z"/></svg>

    </a>
    dib-lab metagenomics rotation project
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/dib-lab/dib_rotation" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    dib_rotation
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Setup
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Setup
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../01_farm_account/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setting up Farm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../02_conda/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install Conda
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Background Reading
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Background Reading
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../03_background_reading/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scientific Literature
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../00a_unix/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Unix Tutorials
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../04_documentation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Keeping a Lab Notebook
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../04b_starting_a_work_session/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Starting a Work Session
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Metagenomics Project
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Metagenomics Project
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../05_starting_with_data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Find and download the data
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../06_quality_control/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quality Control
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../07_taxonomic_discovery_with_sourmash/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Taxonomic Discovery with Sourmash
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Bin Completion with Spacegraphcats
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Bin Completion with Spacegraphcats
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#analysis-options-for-metagenome-samples" class="md-nav__link">
    <span class="md-ellipsis">
      Analysis options for metagenome samples
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#representing-all-the-k-mers-de-bruijn-graphs-and-compact-de-bruijn-graphs" class="md-nav__link">
    <span class="md-ellipsis">
      Representing all the k-mers: de Bruijn graphs and compact de Bruijn graphs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sequence-context-in-a-cdbg" class="md-nav__link">
    <span class="md-ellipsis">
      Sequence context in a cDBG
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scaling-it-up" class="md-nav__link">
    <span class="md-ellipsis">
      Scaling it up
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-spacegraphcats" class="md-nav__link">
    <span class="md-ellipsis">
      Running spacegraphcats
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#comparing-the-query-to-the-neighborhood" class="md-nav__link">
    <span class="md-ellipsis">
      Comparing the query to the neighborhood
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../09_assembling_a_nbhd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Assembling a Nbhd
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../10_annotating_amino_acid_sequences/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Annotating amino acid sequences
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Advanced Modules
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Advanced Modules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../11_workflows_and_repeatability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automation, Workflows, and Repeatability
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../12_angus_github/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Version Control with Git and GitHub
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../13_contribute_on_github/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contribute on GitHub
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#analysis-options-for-metagenome-samples" class="md-nav__link">
    <span class="md-ellipsis">
      Analysis options for metagenome samples
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#representing-all-the-k-mers-de-bruijn-graphs-and-compact-de-bruijn-graphs" class="md-nav__link">
    <span class="md-ellipsis">
      Representing all the k-mers: de Bruijn graphs and compact de Bruijn graphs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sequence-context-in-a-cdbg" class="md-nav__link">
    <span class="md-ellipsis">
      Sequence context in a cDBG
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scaling-it-up" class="md-nav__link">
    <span class="md-ellipsis">
      Scaling it up
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-spacegraphcats" class="md-nav__link">
    <span class="md-ellipsis">
      Running spacegraphcats
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#comparing-the-query-to-the-neighborhood" class="md-nav__link">
    <span class="md-ellipsis">
      Comparing the query to the neighborhood
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Bin Completion with Spacegraphcats</h1>

<p>In the <a href="../07_taxonomic_discovery_with_sourmash/">previous lesson</a>, we used sourmash to determine the approximate taxonomic composition of our metagenome sample. 
Sourmash performs quick exact matching between the k-mers in your sample and k-mers in databases -- this means that a sequence must have been previously sequenced and be in a database in order for us to be able to label it in our sample. 
We often cannot label a lot of the sequences in our sample, especially if that sample comes from a novel environment that has not be sequenced in the past. 
We saw this in the previous lesson, where we were only able to classify ~10% of the reads in our sample.</p>
<pre><code>== This is sourmash version 3.0.1. ==
== Please cite Brown and Irber (2016), doi:10.21105/joss.00027. ==

loaded 1 LCA databases. ksize=31, scaled=10000
selecting specified query k=31
loaded query: SRR1976948... (k=31)

overlap     p_query p_match
---------   ------- --------
2.5 Mbp       0.2%   96.9%      unassigned Methanomicrobiales archaeon 53_19
2.4 Mbp       0.2%   99.2%      Methanobacterium sp. 42_16
2.3 Mbp       0.2%  100.0%      Desulfotomaculum sp. 46_80
2.3 Mbp       0.2%  100.0%      unassigned Actinobacteria bacterium 66_15
2.1 Mbp       0.2%   97.7%      Desulfotomaculum sp. 46_296
2.1 Mbp       0.2%   99.0%      Methanosaeta harundinacea
2.0 Mbp       0.2%   99.0%      unassigned Marinimicrobia bacterium 46_43
1.9 Mbp       0.2%  100.0%      unassigned Bacteroidetes bacterium 38_7
1.9 Mbp       0.2%   55.1%      unassigned Thermotogales bacterium EBM-48
</code></pre>
<h2 id="analysis-options-for-metagenome-samples">Analysis options for metagenome samples</h2>
<p>To get more information out of a metagenomics sample, we have five options. 
1) <strong>Align reads to the genomes that had sourmash matches.</strong> sourmash performs exact matching of k-mers.
K-mers of size 31 are fairly specific.
Even if a sequence had 30 basepairs exactly in common with another sequence, if the 31st is different, it would not count as a match.
Aligning reads to close relatives is a more lenient approach, and could lead to 5-10% more reads being classified.
This is pretty good, but there are ways to do better.</p>
<p>2) <strong><em>de novo</em> assemble and bin the reads into metagenome assembled genomes.</strong>
<em>de novo</em> assembly and binning are reference-free approaches to produce metagenome-assembled genomes (bins) from metagenome reads.
<em>de novo</em> assembly works by finding overlaps between reads and assembling them into larger "contiguous sequences" (usually shortened to contigs).
Depending on the depth, coverage, and biological properties of a sample, these contigs range in size from 500 base pairs to hundreds of thousands of base pairs.
These assemblies can then be binned into metagenome-assembled genomes. Most binners use tetranucleotide frequency and abundance information to bin contigs.
A tetranucleotide is a 4 base pair sequence within a genome.
Almost all tetranucleotides occur in almost all genomes, however the frequency that they occur in a given genome is usually conserved (see <a href="http://peteranoble.com/noble_pubs/noble_1998.pdf">here</a>).
So, binners exploit this information and calculate tetranucleotide frequency for all contigs in an assembly, and group the contigs together that have similar frequencies.
This is also coupled with abundance information; if two contigs belong together, they probably have the same abundance because they came from the same organism in a sample.
These approaches allow researchers to ask questions about the genomes of organisms in metagenomes even if there is no reference that has been sequenced before.
For this reason, they are both very popular and very powerful.
However, both assembly and binning suffer from biases that lead to incomplete results.
Assembly fails when either 1) an area does not have enough reads to cover the region (low coverage) and 2) when the region is too complicated and there are too many viable combinations of sequences so the assembler doesn't know how to make a decision.
This second scenario can occur when there are a lot of errors in the reads, or when there is a lot of strain variation in a genome. 
In either case, the assembly breaks and outputs fragmented contigs, or no contigs at all.
Although tetranucleotide frequency and abundance information are strong signals, tetranucleotide frequency can only be reliably estimated on contigs that are &gt;2000 base pairs.
Because many things fail to assemble to that length, they are not binned. 
To give an idea of how much is missed by <em>de novo</em> assembly and binning, consider our sourmash results.
The sample that we are analyzing was originally analyzed with a <em>de novo</em> assembly and binning pipeline.
The high-quality bins were then uploaded to GenBank and are now part of the database. 
Look at the sourmash output (above). 
Any genome match that ends in two numbers separated by an underscore (e.g. 46_43) is a <em>de novo</em> metagenome-assembled genome produced by the original analysis.
Even with the exact genomes in our sample in the database, we were only able to classify 10% of the k-mers in our sample.
This leaves a lot of data on the table.</p>
<p>3) <strong>Continue the analysis with gene-level techniques.</strong> Often times, many more contigs will assemble than will bin. 
In cases like this, it's possible to do a gene-level analysis of a metagenome where you annotate open reading frames (ORFs) on the assembled contigs.
This type of analysis can give you an idea of the functional potential in our metagenome.</p>
<p>4) <strong>Continue the analysis with read-based techniques.</strong>
If something has no known reference and doesn't assemble or bin, what can you do? 
There are many tools that work directly on metagenome reads to estimate taxonomy or function (e.g. gene identity).
These tools include Kraken and mifaser. 
We've had varying degrees of success with this type of approach, depending on the sample being analyzed.</p>
<p>5) <strong>Exploit connectivity of DNA sequences to assign more reads to the pangenome of sourmash matches.</strong>
We can do this with a tool called spacegraphcats.
The rest of this lesson covers background knowledge for this approach and why it works, and gives a step-by-step guide of how to do it.</p>
<h2 id="representing-all-the-k-mers-de-bruijn-graphs-and-compact-de-bruijn-graphs">Representing all the k-mers: de Bruijn graphs and compact de Bruijn graphs</h2>
<p>In real life, DNA sequences are fully contiguous within a genome (or chromosome). 
When we chop a genome up into little pieces to sequence it, we lose this connectivity information.
In order to get this connectivity information back to create an assembly, we must find every possible set of overlaps between all reads.
This information is often represented in a de Bruijn graph.
A de Bruijn graph is built by chopping sequencing data into k-mers and finding all overlaps of size k-1 between all k-mers.
The graph below demonstrates this process.
Each node in the graph represents a k-mer (here of size 4), and each arrows represents that two k-mers overlap by k-1 nucleotides (here, by 3 nucleotides). 
Each k-mer only occurs in the graph once.</p>
<p><img alt="source: Brief Bioinform. 2018 Jan 1;19(1):23-40. doi: 10.1093/bib/bbw096." src="../_static/A-In-the-de-Bruijn-graph-approach-short-reads-are-split-into-short-k-mers-before-the.png" /></p>
<p>A compact de Bruijn graph (cDBG) is built from the de Bruijn graph by collapsing all linear paths of k-mers into a single node.
Every k-mer still only occurs once in the graph, but now nodes grow in size to be greater than k.</p>
<p><img alt="" src="../_static/cdbg.png" /></p>
<p>Both DBGs and cDBGs contain every k-mer from a sample. 
What's more, with a large enough k-mer size (e.g. 31), k-mers from the same genome tend to be connected within the graph because they are connected within the real genome. 
spacegraphcats takes advantage of this information to reassociate k-mers that belong together but were not recovered by assembly.</p>
<h2 id="sequence-context-in-a-cdbg">Sequence context in a cDBG</h2>
<p>As outlined above, many reads do not match known references, don't assemble, and/or don't bin. 
What if this occurs in a region that you particularly care about?
How can we use the fact that all k-mers in a metagenome are contained within a cDBG to get more information about our region of interest?</p>
<p>Look at the figure below. 
The first part of the abstract of this study states:</p>
<pre><code>Dissimilatory perchlorate reduction is an anaerobic respiratory pathway that in communities might 
be influenced by metabolic interactions. Because the genes for perchlorate reduction are horizontally 
transferred, previous studies have been unable to identify uncultivated perchlorate-reducing 
populations. Here we recovered metagenome-assembled genomes from perchlorate-reducing sediment 
enrichments and employed a manual scaffolding approach to reconstruct gene clusters for perchlorate 
reduction found within mobile genetic elements. 
</code></pre>
<p>Essentially, the authors of this study knew that dissimilatory perchlorate reduction was important in their microbial communities of interest.
But because perchlorate reduction genes are horizontally transferred, they're hard to identify in metagenomic sequencing data.
This is likely because strain variation (e.g. small differences in the same genes in different organisms in a community) around these genes broke assembly.
However, given their importance, the authors of this study knew that they <em>should</em> be present in the metagenome.
Therefore, they dug into the cDBG that contained all metagenome reads, and were able to see the sequence context of their genes of interest. 
We see that because these genes are horizontally transferred, sometimes the sequence flanking their genes of interest comes from multiple species. 
However, even in this case, regions of the sub-cDBG segregate to each species that contains the gene of interest.
In other cases (e.g. at 7% salinity), only one organism flanks <em>pcrA</em>. 
Yet we see from bubbles and offshoots in the graph that even when <em>pcrA</em> is contained only within one species, there is still variation that likely confounded assembly and binning. </p>
<p><img alt="source: ISME J 12, 1568â€“1581 (2018) doi:10.1038/s41396-018-0081-5" src="../_static/41396_2018_81_Fig4_HTML.png" /></p>
<h2 id="scaling-it-up">Scaling it up</h2>
<p>The study we were looking at above looked for genes involved in dissimilatory perchlorate reduction using manual curation -- 
e.g. they built a cDBG for each sample, visualized it with a tool called Bandage, then used BLAST to find their genes of interest.
This approach is great, but incredibly time consuming and difficult to automate. 
What's more, this approach does not scale. 
Given the complexity of cDBGs, each "query" (e.g. look up within the graph) takes a lot of computational resources.
As such, although this approach is tractable for a few genes (and shows really cool results at that scale!), it wouldn't work for every gene that is assembled in a metagenome. 
But imagine if it could!
Using <em>de novo</em> approaches, most bins are not 100% complete. 
What if we could use a whole bin as a query, and pull out its context within a cDBG?
We could "complete" a bin by pulling all the things that didn't assemble or bin, but that through close location in the cDBG, we know belongs with the bin.</p>
<p>Enter spacegraphcats. 
Spacegraphcats uses a novel data structure to represent the cDBG with less complexity while maintaining biological relationships between the sequences. 
It then uses novel algorithms that exploit properties of the cDBG to quickly query into the data structure.</p>
<p>To visualize this, let's look at a cDBG of an <em>Escherichia coli</em> genome + errors 
(this is an isolate, so we're using the errors to simulate strain variation in a real metagenome community. 
It's a rough approximation that works well for visualizing what spacegraphcats does under the hood). 
On the left is the cDBG, and on the right is the simplified structure produced by spacegraphcats.
The structure on the right is much easier to query into.</p>
<p><img alt="" src="../_static/ecoli_cdbg_sgc.png" /></p>
<p>Spacegraphcats queries work by decomposing the query into k-mers, finding the node in which a query k-mer is contained within the spacegraphcats graph, and returning all of the k-mers in that node. 
This process is efficient enough to work on the whole metagenome for every k-mer in the query.</p>
<h2 id="running-spacegraphcats">Running spacegraphcats</h2>
<p>Let's try this out on our metagenome! 
First, let's install spacegraphcats.
We're going to create a new environment for spacegraphcats, and follow the installation instructions from the spacegraphcats github repository.</p>
<p>First, start an <code>srun</code> session</p>
<pre><code>srun -p bmh -J sgc -t 48:00:00 --mem=70gb -c 2 --pty bash
</code></pre>
<p>Make sure you start from the base environment.
If you're in another environment (e.g. <code>dib_rotation</code>), run <code>conda deactivate</code>.</p>
<p>Go back to your home directory:</p>
<pre><code>cd ~
</code></pre>
<p>Clone the spacegraphcats remote repository from GitHub to our remote computer on Farm:</p>
<pre><code>git clone https://github.com/spacegraphcats/spacegraphcats/
</code></pre>
<p>Using the <code>environment.yml</code> file in your newly clones spacegraphcats repository, create a new conda environment with the dependencies required to run spacegraphcats, named <code>sgc</code>:</p>
<pre><code>conda env create -f spacegraphcats/environment.yml -n sgc
</code></pre>
<blockquote>
<ul>
<li><code>conda env create</code> will create a new conda environment from a file</li>
<li><code>-f</code> points to the file containing the environment specifications</li>
<li><code>-n</code> specifies a name to give your new environment</li>
</ul>
</blockquote>
<p>Activate the new <code>sgc</code> conda environment:</p>
<pre><code>conda activate sgc
</code></pre>
<p>Install the beta version of spacegraphcats package in the <code>sgc</code> environment with <code>pip</code>.</p>
<pre><code>pip install --pre spacegraphcats
</code></pre>
<p>Next, we need to decide what query we'd like to use. 
Let's try <em>Desulfotomaculum sp. 46_80</em>, which we saw from sourmash is 100% present in the metagenome</p>
<pre><code>2.3 Mbp       0.2%  100.0%      Desulfotomaculum sp. 46_80
</code></pre>
<p>We first have to find this genome sequence. 
To do this, we can go to <a href="https://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi">NCBI taxonomy browser</a> and search for <code>Desulfotomaculum sp. 46_80</code>.
We see that this takes us to a new page.
On the right hand side of the screen, there should be a box. 
Click the <code>1</code> that's in the <code>Assembly</code> row, and this will take us to the genome bin assembly record.
Then, on the right hand side, click <code>FTP directory for GenBank assembly</code>.
This takes us to the FTP site for this assembly. 
We can download the assembly to FARM using <code>wget</code> and the link address for the file we want.
Here, we want the <code>*.fna.gz</code> file, as this contains the nucleotides from the metagenome-assembled genome.</p>
<pre><code>cd ~/2020_rotation_project
mkdir -p sgc
cd sgc
wget ftp://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/001/508/995/GCA_001508995.1_ASM150899v1/GCA_001508995.1_ASM150899v1_genomic.fna.gz
</code></pre>
<p>Now that we have our query, we need to construct a configuration file that spacegraphcats will use to run.
This file specifies the name of the spacegraphcats data structure (<code>catlas_base</code>), the file paths for the metagenome reads and the query sequence, the k-mer size at which to build the cDBG, and the "radius" (or size) at which to perform the queries.</p>
<p>The file will contain:</p>
<pre><code>catlas_base: 'SRR1976948'
input_sequences:
- ../abundtrim/SRR1976948.abundtrim.fq.gz
ksize: 31
radius: 1
search:
- GCA_001508995.1_ASM150899v1_genomic.fna.gz
searchquick: GCA_001508995.1_ASM150899v1_genomic.fna.gz
</code></pre>
<p>Use a text editor such as nano or vim to generate this file, and call it <code>conf1.yml</code>.
(Here's a tutorial on using <a href="https://datacarpentry.org/shell-genomics/05-writing-scripts">nano</a>.)</p>
<p>For using vim, however...</p>
<p>First, create a file with the <code>vi</code> or <code>vim</code> command. This creates a file called <code>conf1.yml</code> and opens the file in vim.</p>
<pre><code>vim conf1.yml
</code></pre>
<p>Upon entering, vim is set to <code>normal</code> mode. This allows the user to use commands directly on the file and so much more.
Now, press <code>i</code> to enter <code>insert</code> mode. You should see "-- INSERT -- "at the bottom of the terminal, indicating that you are now able to alter you text file. Paste the copied <code>conf1.yaml</code> text now.</p>
<p>Your terminal should look similar to this:</p>
<pre><code>catlas_base: 'SRR1976948'
input_sequences:
- ../abundtrim/SRR1976948.abundtrim.fq.gz
ksize: 31
radius: 1
search:
- GCA_001508995.1_ASM150899v1_genomic.fna.gz
searchquick: GCA_001508995.1_ASM150899v1_genomic.fna.gz
~                                                                  
~                                                                  
~                                                                  
-- INSERT --                                     1,1           All
</code></pre>
<p>To save the file and exit the vim text editor, you need to exit <code>insert</code> mode with <code>esc</code>. You are now back in <code>normal</code> mode. Yay!... But, how do you leave the file?
Type <code>:wq</code> and press Enter to save the file and exit vim.</p>
<blockquote>
<ul>
<li><code>:</code> switches vim to command-line mode</li>
<li><code>:w</code> writes changes to a file</li>
<li><code>:q</code> quits a file</li>
<li><code>:wq</code> writes and quits a file</li>
</ul>
</blockquote>
<p>One final option is to use <code>cat</code> to write multiple lines of text into a file between two End Of File (<code>EOF</code>) markers. Copy and paste all 11 lines below into your shell prompt at once:</p>
<pre><code>cat &gt; conf1.yaml &lt;&lt; EOF
catlas_base: 'SRR1976948'
input_sequences:
- ../abundtrim/SRR1976948.abundtrim.fq.gz
ksize: 31
radius: 1
search:
- GCA_001508995.1_ASM150899v1_genomic.fna.gz
searchquick: GCA_001508995.1_ASM150899v1_genomic.fna.gz
EOF
</code></pre>
<p>Now we're ready to run spacegraphcats!</p>
<pre><code>python -m spacegraphcats run conf1.yml extract_contigs extract_reads --nolock 
</code></pre>
<p>This will take a while to run. 
When it is finished, you will have three folders in your directory: 
+ <code>SRR1976948</code>: contains the cDBG
+ <code>SRR1976948_k31_r1</code>: contains the spacegraphcats data structures
+ <code>SRR1976948_k31_r1_search_oh0</code>: contains the output of the query, including the contigs (single paths) from the cDBG, the reads that contain k-mers in those contigs, and a sourmash signature from the contigs.</p>
<h2 id="comparing-the-query-to-the-neighborhood">Comparing the query to the neighborhood</h2>
<p>Let's explore how similar the query is to the neighborhood we extracted with it.</p>
<p>We will use sourmash to do this. We already have a sourmash signature our neighborhood that was output by spacegraphcats.
Let's make a signature for our query as well, and then use <code>sourmash compare</code> to compare them.</p>
<pre><code>sourmash sketch -p k=21,k=31,k=51,scaled=2000 -o GCA_001508995.1_ASM150899v1_genomic.sig GCA_001508995.1_ASM150899v1_genomic.fna.gz
</code></pre>
<pre><code>sourmash compare -k 31 --csv comp1.csv *sig SRR1976948_k31_r1_search_oh0/*sig
</code></pre>
<p>How similar are these two signatures? 
Did spacegraphcats add any additional sequence to this query?</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2020 <a href="http://ivory.idyll.org/lab/">Lab for Data Intensive Biology</a> at UC Davis
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.8fd75fb4.min.js"></script>
      
    
  </body>
</html>